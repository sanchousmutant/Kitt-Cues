name: ğŸš€ Build and Deploy TypeScript to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize]
  workflow_dispatch: # ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  issues: write  # ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² PR/issues
  pull-requests: write  # ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² PR

# Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ½Ñƒ ÑĞ±Ğ¾Ñ€ĞºÑƒ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° TypeScript Ğ¸ Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³
  lint-and-type-check:
    name: ğŸ” Lint and Type Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19'
          cache: 'npm'
          
      - name: âœ… Verify Node.js version
        run: |
          node --version
          echo "âœ… Using Node.js $(node --version)"
          
      - name: ğŸ“‹ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: ğŸ” Type check
        run: npm run type-check
        
      - name: ğŸ“ Create type check report
        run: |
          echo "âœ… TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ All types are valid and no errors found" >> $GITHUB_STEP_SUMMARY

  # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
  build-and-deploy:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ git
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19'
          cache: 'npm'
          
      - name: âœ… Verify Node.js version
        run: |
          node --version
          npm --version
          echo "Node.js version check: $(node --version)"
          NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1,2)
          REQUIRED_VERSION="20.19"
          if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NODE_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
            echo "âŒ Node.js version $NODE_VERSION is too old. Required: 20.19+"
            exit 1
          fi
          echo "âœ… Node.js version is compatible"
          
      - name: ğŸ”§ Configure npm
        run: |
          npm config set fund false
          npm config set audit-level moderate
          
      - name: ğŸ“‹ Install dependencies
        run: |
          echo "Installing dependencies..."
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"
          
      - name: ğŸ” Verify TypeScript setup
        run: |
          echo "Checking TypeScript configuration..."
          npx tsc --version
          echo "âœ… TypeScript is ready"
          
      - name: ğŸ—ï¸ Build TypeScript project
        run: |
          echo "Building TypeScript project..."
          npm run build-with-types || npm run build
          echo "âœ… Build completed successfully"
          
      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸ¯ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript compilation: Success" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Vite bundling: Success" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ Output directory: \`dist/\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ Files generated:" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ | head -10 >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ”§ Setup GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload artifact for GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          
      - name: ğŸš€ Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ğŸ“ Deployment summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## ğŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- â° Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¯ Build Preview
              
              âœ… TypeScript build completed successfully!
              
              **Build Details:**
              - ğŸ” Type checking: Passed
              - ğŸ—ï¸ Vite bundling: Completed  
              - ğŸ“¦ Artifacts ready for deployment
              
              The changes are ready to be merged and deployed to production.`
            })