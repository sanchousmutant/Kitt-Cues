name: ðŸ”„ Continuous Integration

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00 UTC
    - cron: '0 2 * * *'

jobs:
  test-matrix:
    name: ðŸ§ª Test on Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20, 22]
        
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        
      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ðŸ“‹ Install dependencies
        run: npm ci --prefer-offline
        
      - name: ðŸ” Type check
        run: npm run type-check
        
      - name: ðŸ—ï¸ Test build
        run: npm run build-with-types || npm run build
        
      - name: ðŸ“Š Build size check
        run: |
          echo "## ðŸ“Š Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Node.js version: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            echo "Build directory size: $(du -sh dist/ | cut -f1)" >> $GITHUB_STEP_SUMMARY
            echo "Files in build:" >> $GITHUB_STEP_SUMMARY
            ls -lah dist/ >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“‹ Install dependencies
        run: npm ci --prefer-offline
        
      - name: ðŸ”’ Run security audit
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“¦ Check for outdated packages
        run: |
          echo "## ðŸ“¦ Package Status" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || echo "All packages are up to date" >> $GITHUB_STEP_SUMMARY

  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v5
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“‹ Install dependencies
        run: npm ci --prefer-offline
        
      - name: ðŸ—ï¸ Build project
        run: npm run build-with-types || npm run build
        
      - name: ðŸ“ Bundle size analysis
        run: |
          echo "## âš¡ Performance Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist" ]; then
            # Ð Ð°Ð·Ð¼ÐµÑ€ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            echo "### ðŸ“Š Bundle Sizes" >> $GITHUB_STEP_SUMMARY
            find dist -name "*.js" -exec ls -lh {} \; | awk '{print "- JavaScript: " $5 " (" $9 ")"}' >> $GITHUB_STEP_SUMMARY
            find dist -name "*.css" -exec ls -lh {} \; | awk '{print "- CSS: " $5 " (" $9 ")"}' >> $GITHUB_STEP_SUMMARY
            
            # ÐžÐ±Ñ‰Ð¸Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€
            total_size=$(du -sh dist/ | cut -f1)
            echo "- **Total build size: ${total_size}**" >> $GITHUB_STEP_SUMMARY
            
            # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²
            file_count=$(find dist -type f | wc -l)
            echo "- **File count: ${file_count}**" >> $GITHUB_STEP_SUMMARY
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
            echo "### ðŸš¨ Large Files Check" >> $GITHUB_STEP_SUMMARY
            large_files=$(find dist -size +500k -type f)
            if [ -n "$large_files" ]; then
              echo "âš ï¸ Large files detected:" >> $GITHUB_STEP_SUMMARY
              echo "$large_files" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No large files detected" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Build directory not found" >> $GITHUB_STEP_SUMMARY
          fi